{% load static %}
{% load humanize %}
{% with current_depth=depth|default:1 %}
<div class="ms-4 mt-3 border-start ps-3">

  <!-- 🧾 Comment Content -->
  <div class="d-flex align-items-start">
    
    <!-- 👤 Clickable Profile Photo -->
    <a href="{% url 'user_profile' comment.user.username %}">
      <img src="{% if comment.user.profile.photo %}{{ comment.user.profile.photo.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}"
           class="rounded-circle me-3" width="40" height="40" alt="Avatar" style="object-fit: cover;">
    </a>

    <div class="w-100">
      <p class="mb-1">
        <strong>
          <a href="{% url 'user_profile' comment.user.username %}">{{ comment.user.username }}</a>
        </strong>

        {% if comment.user.profile.role %}
          {% with role=comment.user.profile.role|lower %}
            <span class="badge rounded-pill px-3 py-1 text-white ms-2
              {% if role == 'teacher' %}bg-primary
              {% elif role == 'admin' %}bg-danger
              {% elif role == 'student' %}bg-success
              {% else %}bg-secondary
              {% endif %}">
              {{ comment.user.profile.role }}
            </span>
          {% endwith %}
        {% endif %}

        — {{ comment.created|naturaltime }}
        <span class="badge bg-secondary float-end">{{ comment.replies.count }} Replies</span>
      </p>

      <p>{{ comment.body }}</p>

      <!-- 👍 Like Button -->
      <form method="POST" action="{% url 'like_comment' comment.id %}" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm {% if user in comment.likes.all %}btn-success{% else %}btn-outline-success{% endif %}">
          👍 {{ comment.total_likes }}
        </button>
      </form>

      {% if user == comment.user %}
        <a href="{% url 'edit_comment' comment.id %}" class="btn btn-sm btn-warning">Edit</a>
        <a href="{% url 'delete_comment' comment.id %}" class="btn btn-sm btn-danger"
           onclick="return confirm('Are you sure you want to delete this comment?')">Delete</a>
      {% endif %}

      <!-- 🔁 Reply to this comment -->
      <a class="btn btn-sm btn-link" data-bs-toggle="collapse" href="#replyForm{{ comment.id }}">Reply</a>
      <div id="replyForm{{ comment.id }}" class="collapse mt-2">
        <form method="POST" action="{% url 'reply_comment' post.id comment.id %}">
          {% csrf_token %}
          <textarea name="body" class="form-control" rows="2" placeholder="Write your reply..." required></textarea>
          <button type="submit" class="btn btn-sm btn-primary mt-2">Submit Reply</button>
        </form>
      </div>

      <!-- 🔁 Replies -->
      {% if comment.replies.all %}
        {% if current_depth < 2 %}
          {% for reply in comment.replies.all %}
            {% include "comment_tree.html" with comment=reply post=post user=user depth=current_depth|add:"1" %}
          {% endfor %}
        {% else %}
          <!-- Collapsible Replies beyond max_depth -->
          <a class="btn btn-sm btn-outline-secondary mt-2" data-bs-toggle="collapse" href="#moreReplies{{ comment.id }}">
            🔽 View {{ comment.replies.count }} more repl{{ comment.replies.count|pluralize:"y,ies" }}
          </a>
          <div class="collapse mt-2" id="moreReplies{{ comment.id }}">
            {% for reply in comment.replies.all %}
              {% include "comment_tree.html" with comment=reply post=post user=user depth=current_depth|add:"1" %}
            {% endfor %}
          </div>
        {% endif %}
      {% endif %}

    </div>
  </div>
</div>
{% endwith %}
