{% load static %}
{% load group_tags %} 
{% load custom_filters %}
{% block extrahead %}
  {{ form.media }}
{% endblock %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}SMARTPACE{% endblock %}</title>
  <meta name="csrf-token" content="{{ csrf_token }}">

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">

  <!-- Custom Styles -->
  <style>
    html, body { max-width: 100%; overflow-x: hidden; margin: 0; padding: 0; }
    body { padding-top: 70px; }

    footer { background-color: #f8f9fa; padding: 1rem 0; margin-top: 4rem; border-top: 1px solid #dee2e6; }

    .btn-primary:hover, .btn-success:hover {
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      transform: scale(1.05);
      transition: all 0.3s ease-in-out;
    }

    /* Nested comments */
    .nested-comment { padding-left: 1rem; }
    .depth-2 { padding-left: 1.5rem; }
    .depth-3 { padding-left: 2rem; }
    .depth-4 { padding-left: 2.5rem; }
    .depth-5 { padding-left: 3rem; }

    @media (max-width: 768px) {
      .depth-2 { padding-left: 2rem; }
      .depth-3 { padding-left: 3rem; }
      .depth-4 { padding-left: 4rem; }
      .depth-5 { padding-left: 5rem; }
    }

    /* Toast animation */
    .toast { animation: fadeInDown 0.5s ease both; }
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Quiz explanations */
    .quiz-explanation {
      background-color: #f8f9fa; color: #212529; padding: 1rem;
      border-left: 4px solid #0d6efd; border-radius: 5px; margin-top: 1rem;
    }
    body[data-bs-theme="dark"] .quiz-explanation {
      background-color: #212529; color: #f8f9fa; border-left-color: #0dcaf0;
    }

    /* Mobile comment indentation */
    @media (max-width: 576px) {
      .comment { margin-left: calc(var(--indent, 0px) * 0.5); }
    }
  </style>

  {% block extra_head %}{% endblock %}
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top shadow-sm px-3">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{% url 'home' %}">SMARTPACE</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <!-- Left (Brand + optional essential links) -->
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="{% url 'home' %}"><i class="bi bi-house-door"></i> Home</a></li>
      </ul>

      <!-- Right (all user links, buttons, dropdowns) -->
      <ul class="navbar-nav ms-auto align-items-center">
        <!-- Quiz History for staff -->
        {% if user.is_authenticated and user.is_staff %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'quiz_history' %}"><i class="bi bi-journal-text"></i> Quiz History</a>
          </li>
        {% endif %}

        <!-- Chat -->
        <li class="nav-item"><a class="nav-link" href="{% url 'chat:user_list' %}"><i class="bi bi-chat-dots"></i> Chat</a></li>

        <!-- Teacher Dashboard / Results -->
        {% if request.user.is_authenticated %}
          {% if request.user|has_group:"Teacher" %}
            <li class="nav-item"><a class="nav-link" href="{% url 'teacher_dashboard' %}">üë©‚Äçüè´ Teacher Dashboard</a></li>
          {% else %}
            <li class="nav-item"><a class="nav-link" href="{% url 'my_graded_homework' %}">üìÑ Results</a></li>
          {% endif %}
        {% endif %}

        <!-- Leaderboard -->
        <li class="nav-item"><a class="nav-link" href="{% url 'quiz_leaderboard' %}"><i class="bi bi-trophy"></i> Leaderboard</a></li>

        <!-- Analytics (Staff/Superuser) -->
        {% if user.is_staff or user.is_superuser %}
          <li class="nav-item"><a class="nav-link" href="{% url 'most_attempted_categories' %}"><i class="bi bi-bar-chart-line"></i> Analytics</a></li>
        {% endif %}
          
          {% if request.user.is_authenticated %}
  {% if request.user|has_group:"Teacher" %}
    <li class="nav-item">
      <a class="nav-link" href="{% url 'teacher_dashboard' %}">üë©‚Äçüè´ Teacher Dashboard</a>
    </li>
  {% elif request.user.is_staff %}
    <li class="nav-item">
      <a class="nav-link" href="{% url 'teacher_dashboard' %}">üë©‚Äçüè´ Teacher</a>
    </li>
  {% else %}
    <li class="nav-item">
      <a class="nav-link" href="{% url 'my_graded_homework' %}">üìÑ Results</a>
    </li>
  {% endif %}
{% endif %}



        <!-- Support -->
        <li class="nav-item"><a class="nav-link" href="{% url 'support' %}"><i class="bi bi-cash-coin"></i> Support</a></li>

        <!-- Homework -->
        <li class="nav-item"><a class="nav-link btn btn-outline-primary me-2" href="{% url 'homework_list' %}">Homework</a></li>

        <!-- Grade/Form -->
        <li class="nav-item"><a class="nav-link btn btn-outline-success me-2" href="{% url 'select_group' %}">Grade/Form</a></li>

        <!-- Add Post for authenticated users -->
        {% if user.is_authenticated %}
          <li class="nav-item me-2">
            <a href="{% url 'add_post' %}" class="btn btn-success btn-sm rounded-pill">
              <i class="bi bi-plus-circle me-1"></i> Add Post
            </a>
          </li>
        {% endif %}

        <!-- Notifications -->
        <li class="nav-item dropdown me-2">
          <a class="nav-link position-relative d-flex align-items-center gap-1"
             href="#" id="notifDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i id="notif-bell" class="bi bi-bell fs-5"></i>
            <span id="notif-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                  style="font-size: 0.6rem; display: none;">0</span>
          </a>
          <ul id="notif-list" class="dropdown-menu dropdown-menu-end p-2" style="width: 300px; max-height: 250px; overflow-y: auto;">
            <li class="dropdown-item text-muted">Loading...</li>
          </ul>
        </li>

        <!-- Profile / Auth -->
        {% if user.is_authenticated %}
          <li class="nav-item d-flex align-items-center">
            <a class="nav-link d-flex align-items-center" href="{% url 'user_profile' username=user.username %}">
              {% if user.profile.photo %}
                <img src="{{ user.profile.photo.url }}" alt="Profile Photo" class="rounded-circle me-2" width="30" height="30" style="object-fit: cover;">
              {% else %}
                <img src="https://res.cloudinary.com/dwp0xtvyb/image/upload/v1/defaults/avatar.png" alt="Default Photo" class="rounded-circle me-2" width="30" height="30" style="object-fit: cover;">
              {% endif %}
              <span class="fw-semibold">{{ user.username }}</span>
            </a>
          </li>
          <li class="nav-item">
            <form method="post" action="{% url 'logout' %}" class="d-inline m-0 p-0">
              {% csrf_token %}
              <button type="submit" class="nav-link btn btn-link text-decoration-none"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </form>
          </li>
        {% else %}
          <li class="nav-item"><a class="nav-link" href="{% url 'login' %}"><i class="bi bi-shield-lock"></i> Login</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'register' %}"><i class="bi bi-pencil-square"></i> Register</a></li>
        {% endif %}

        <!-- Search -->
        <form class="d-flex ms-3" method="GET" action="{% url 'search' %}">
          <input class="form-control me-2" type="search" name="q" placeholder="Search..." required>
          <button class="btn btn-outline-primary" type="submit"><i class="bi bi-search"></i></button>
        </form>

      </ul>
    </div>
  </div>
</nav>

<!-- Messages -->
<div class="mt-5">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} mt-3">{{ message }}</div>
    {% endfor %}
  {% endif %}
</div>

<!-- Main Content -->
<main class="container-fluid mt-4 px-0">
  {% block content %}{% endblock %}
</main>

<!-- Footer -->
<footer class="text-center">
  <div class="container">
    <p class="mb-0">&copy; {{ now|date:"Y" }} SMARTPACE. All rights reserved.</p>
  </div>
</footer>

<!-- Notification & Toast JS -->
<audio id="notification-sound" src="{% static 'sounds/notification.mp3' %}" preload="auto"></audio>
<div class="toast-container position-fixed top-0 end-0 p-3" id="toast-container" style="z-index: 9999;"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Notifications Script -->
<script>
const shownNotifs = new Set();
const audio = document.getElementById("notification-sound");
let audioUnlocked = false;

document.addEventListener('click', () => {
  if (!audioUnlocked && audio) {
    audio.play().then(()=>{audio.pause();audio.currentTime=0; audioUnlocked=true;}).catch(()=>{});
  }
});

function showToast(message, url='#', tone='primary', photoUrl=''){
  const container = document.getElementById('toast-container');
  if(container.children.length>=3) container.removeChild(container.firstChild);
  const toast = document.createElement('div');
  toast.className = `toast text-bg-${tone} align-items-center border-0 show mb-2`;
  toast.innerHTML = `
    <div class="d-flex">
      ${photoUrl?`<img src="${photoUrl}" class="rounded-circle me-2" style="width:30px;height:30px;" alt="Photo">`:''}
      <div class="toast-body"><a href="${url}" class="text-white text-decoration-none">${message}</a></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>`;
  container.appendChild(toast);
  new bootstrap.Toast(toast,{delay:5000}).show();
}

function fetchNotifications(){
  fetch("{% url 'unread_notifications_json' %}").then(res=>res.json()).then(data=>{
    const notifList = document.getElementById('notif-list');
    const notifCount = document.getElementById('notif-count');
    if(notifList) notifList.innerHTML='';
    if(notifCount) notifCount.textContent = data.length;
    if(data.length===0 && notifList) notifList.innerHTML='<li class="dropdown-item text-muted">No new notifications</li>';
    data.forEach(n=>{
      const uniqueId = n.message+n.url;
      if(!shownNotifs.has(uniqueId)){ showToast(n.message,n.url,n.tone||'primary',n.photo||''); shownNotifs.add(uniqueId); }
      if(notifList){ const li=document.createElement('li'); li.className='dropdown-item'; li.innerHTML=`<a href="${n.url}" class="text-decoration-none">${n.message}</a>`; notifList.appendChild(li); }
    });
  }).catch(err=>console.error(err));
}

document.addEventListener("DOMContentLoaded",()=>{ fetchNotifications(); setInterval(fetchNotifications,30000); });
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
