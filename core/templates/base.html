{% load static %}
{% load group_tags %}
{% load custom_filters %}
{% block extrahead %}
  {{ form.media }}
{% endblock %}
<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}SMARTPACE{% endblock %}</title>
  <meta name="csrf-token" content="{{ csrf_token }}">

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">

  <!-- Custom Styles -->
  <style>

/* ===== Dark Mode for Posts ===== */
body.dark-mode .post-content {
    background-color: #121212;   /* dark background for the post */
    color: #e0e0e0;             /* light text color */
}

/* Post title */
body.dark-mode .post-content h4,
body.dark-mode .post-content h5 {
    color: #ffffff;
}

/* Post meta info (date, category) */
body.dark-mode .post-content p.text-secondary,
body.dark-mode .post-content span.text-secondary {
    color: #b0b0b0;  /* muted light gray */
}

/* Post excerpt/content */
body.dark-mode .post-content p.text-body {
    color: #e0e0e0;
}

/* Post cards / media container */
body.dark-mode .post-content .card,
body.dark-mode .post-content .accordion,
body.dark-mode .post-content .daily-quote {
    background-color: #1e1e1e;
    color: #e0e0e0;
    border-color: #333;
}

/* Links inside posts */
body.dark-mode .post-content a {
    color: #bb86fc;  /* nice purple accent */
}
body.dark-mode .post-content a:hover {
    color: #e0e0e0;
}


    html, body {
      max-width: 100%;
      overflow-x: hidden;
      margin: 0;
      padding: 0;
    }
    body { padding-top: 70px; }

    footer {
      background-color: #f8f9fa;
      padding: 1rem 0;
      margin-top: 4rem;
      border-top: 1px solid #dee2e6;
    }

    .btn-primary:hover, .btn-success:hover {
      box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
      transform: scale(1.05);
      transition: all 0.3s ease-in-out;
    }

    /* Nested comments */
    .nested-comment { padding-left: 1rem; }
    .depth-2 { padding-left: 1.5rem; }
    .depth-3 { padding-left: 2rem; }
    .depth-4 { padding-left: 2.5rem; }
    .depth-5 { padding-left: 3rem; }

    @media (max-width: 768px) {
      .depth-2 { padding-left: 2rem; }
      .depth-3 { padding-left: 3rem; }
      .depth-4 { padding-left: 4rem; }
      .depth-5 { padding-left: 5rem; }
    }

    /* Toast animation */
    .toast { animation: fadeInDown 0.5s ease both; }
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Quiz explanations */
    .quiz-explanation {
      background-color: #f8f9fa;
      color: #212529;
      padding: 1rem;
      border-left: 4px solid #0d6efd;
      border-radius: 5px;
      margin-top: 1rem;
    }

    /* Mobile comment indentation */
    @media (max-width: 576px) {
      .comment { margin-left: calc(var(--indent, 0px) * 0.5); }
    }

    /* Default dark background with blur cards */
    body { background: radial-gradient(circle at top, #0a0a0f 0%, #000 100%); }
    .card { backdrop-filter: blur(8px); }

    /* Light/Dark Theme Overrides */
    html[data-bs-theme="light"] body {
        background: #f8f9fa;
        color: #212529;
    }

    html[data-bs-theme="dark"] {
        background: radial-gradient(circle at top, #0a0a0f 0%, #000 100%);
        color: #f8f9fa;
    }

    /* Ensure all text is visible in dark mode */
    html[data-bs-theme="dark"] body,
    html[data-bs-theme="dark"] p,
    html[data-bs-theme="dark"] span,
    html[data-bs-theme="dark"] li,
    html[data-bs-theme="dark"] a,
    html[data-bs-theme="dark"] h1,
    html[data-bs-theme="dark"] h2,
    html[data-bs-theme="dark"] h3,
    html[data-bs-theme="dark"] h4,
    html[data-bs-theme="dark"] h5,
    html[data-bs-theme="dark"] h6 {
        color: #f8f9fa !important;
    }

    /* Cards background in dark mode */
    html[data-bs-theme="dark"] .card {
        background-color: rgba(30,30,30,0.85);
        color: #f8f9fa;
    }

    /* Links in dark mode */
    html[data-bs-theme="dark"] a { color: #020202 !important; }
    html[data-bs-theme="dark"] a:hover { color: #0c7ab0 !important; }

    /* Buttons in dark mode */
    html[data-bs-theme="dark"] .btn-outline-primary {
        color: #0dcaf0;
        border-color: #0dcaf0;
    }
    html[data-bs-theme="dark"] .btn-outline-primary:hover {
        background-color: #0dcaf0;
        color: #000;
    }

    html[data-bs-theme="dark"] .quiz-explanation {
        background-color: #212529;
        color: #f8f9fa;
        border-left-color: #0dcaf0;

    }

    /* Ensure post content, titles, and comments are visible in dark mode */
html[data-bs-theme="dark"] .post-title,
html[data-bs-theme="dark"] .post-content,
html[data-bs-theme="dark"] .comment,
html[data-bs-theme="dark"] .comment-body {
    color: #f8f9fa !important;
}

/* Optional: make sure links inside posts/comments are visible */
html[data-bs-theme="dark"] .post-content a,
html[data-bs-theme="dark"] .comment-body a {
    color: #0dcaf0 !important;
}
html[data-bs-theme="dark"] .post-content a:hover,
html[data-bs-theme="dark"] .comment-body a:hover {
    color: #66d9ef !important;
}

/* Ensure code blocks or pre tags inside posts are readable */
html[data-bs-theme="dark"] pre,
html[data-bs-theme="dark"] code {
    background-color: #1e1e1e;
    color: #f8f9fa;
}

/* === Navbar Bootstrap Icons: white in dark mode === */
html[data-bs-theme="dark"] .navbar .bi {
    color: #ffffff !important;
}

  </style>

  {% block extra_head %}{% endblock %}
</head>
<body>
<!-- Navbar -->
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top shadow-sm px-3">
  <div class="container-fluid">
    <!-- Brand / Home -->
    <a class="navbar-brand fw-bold" href="{% url 'home' %}">SMARTPACE</a>
    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <!-- Left: Home -->
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" href="{% url 'home' %}">
            <i class="bi bi-house-door"></i> Home
          </a>
        </li>
      </ul>

      <!-- Right: All other links -->
      <ul class="navbar-nav align-items-center">
        <!-- Theme toggle -->
        <li class="nav-item me-2">
          <button id="theme-toggle" class="btn btn-outline-secondary btn-sm">üåô</button>
        </li>

        {% if user.is_authenticated and user.is_staff %}
          <li class="nav-item me-2">
            <a class="nav-link" href="{% url 'quiz_history' %}">
              <i class="bi bi-journal-text"></i> Quiz History
            </a>
          </li>
        {% endif %}

        {% if user.is_authenticated %}
          <li class="nav-item me-2">
            <a class="nav-link" href="{% url 'manage_subscriptions' %}">Subscriptions</a>
          </li>
        {% endif %}

        <li class="nav-item me-2">
          <a class="nav-link" href="{% url 'chat:user_list' %}">
            <i class="bi bi-chat-dots"></i> Chat
          </a>
        </li>

        {% if user.is_authenticated %}
          {% if request.user|has_group:"Teacher" %}
            <li class="nav-item me-2">
              <a class="nav-link" href="{% url 'teacher_dashboard' %}">üë©‚Äçüè´ Teacher Dashboard</a>
            </li>
          {% else %}
            <li class="nav-item me-2">
              <a class="nav-link" href="{% url 'my_graded_homework' %}">üìÑ Results</a>
            </li>
          {% endif %}
        {% endif %}

        <li class="nav-item me-2">
          <a class="nav-link" href="{% url 'quiz_leaderboard' %}">
            <i class="bi bi-trophy"></i> Leaderboard
          </a>
        </li>

        {% if user.is_staff or user.is_superuser %}
          <li class="nav-item me-2">
            <a class="nav-link" href="{% url 'most_attempted_categories' %}">
              <i class="bi bi-bar-chart-line"></i> Analytics
            </a>
          </li>
        {% endif %}

        <li class="nav-item me-2">
          <a class="nav-link" href="{% url 'support' %}">
            <i class="bi bi-cash-coin"></i> Support
          </a>
        </li>

        <li class="nav-item me-2">
          <a class="nav-link btn btn-outline-primary btn-sm" href="{% url 'homework_list' %}">Homework</a>
        </li>
        <li class="nav-item me-2">
          <a class="nav-link btn btn-outline-success btn-sm" href="{% url 'select_group' %}">Grade/Form</a>
        </li>

        {% if user.is_authenticated %}
          <li class="nav-item me-2">
            <a href="{% url 'add_post' %}" class="btn btn-success btn-sm rounded-pill">
              <i class="bi bi-plus-circle me-1"></i> Add Post
            </a>
          </li>
        {% endif %}

        <!-- Notifications -->
        <li class="nav-item dropdown me-2">
          <a class="nav-link position-relative d-flex align-items-center gap-1" href="#" id="notifDropdown"
             role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i id="notif-bell" class="bi bi-bell fs-5"></i>
            <span id="notif-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                  style="font-size: 0.6rem; display: none;">0</span>
          </a>
          <ul id="notif-list" class="dropdown-menu dropdown-menu-end p-2"
              style="width: 300px; max-height: 250px; overflow-y: auto;">
            <li class="dropdown-item text-muted">Loading...</li>
          </ul>
        </li>

        {% if user.is_authenticated %}
          <li class="nav-item me-2 d-flex align-items-center">
            <a class="nav-link d-flex align-items-center" href="{% url 'user_profile' username=user.username %}">
              {% if user.profile.photo %}
                <img src="{{ user.profile.photo.url }}" alt="Profile Photo"
                     class="rounded-circle me-2" width="30" height="30" style="object-fit: cover;">
              {% else %}
                <img src="https://res.cloudinary.com/dwp0xtvyb/image/upload/v1/defaults/avatar.png"
                     alt="Default Photo" class="rounded-circle me-2" width="30" height="30" style="object-fit: cover;">
              {% endif %}
              <span class="fw-semibold">{{ user.username }}</span>
            </a>
          </li>
          <li class="nav-item me-2">
            <form method="post" action="{% url 'logout' %}" class="d-inline m-0 p-0">
              {% csrf_token %}
              <button type="submit" class="nav-link btn btn-link text-decoration-none">
                <i class="bi bi-box-arrow-right"></i> Logout
              </button>
            </form>
          </li>
        {% else %}
          <li class="nav-item me-2">
            <a class="nav-link" href="{% url 'login' %}"><i class="bi bi-shield-lock"></i> Login</a>
          </li>
          <li class="nav-item me-2">
            <a class="nav-link" href="{% url 'register' %}"><i class="bi bi-pencil-square"></i> Register</a>
          </li>
        {% endif %}

        <!-- Search form -->
        <li class="nav-item ms-2">
          <form class="d-flex" method="GET" action="{% url 'search' %}">
            <input class="form-control me-2" type="search" name="q" placeholder="Search..." required>
            <button class="btn btn-outline-primary" type="submit"><i class="bi bi-search"></i></button>
          </form>
        </li>
      </ul>
    </div>
  </div>
</nav>



<!-- Messages -->
<div class="mt-5">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} mt-3">{{ message }}</div>
    {% endfor %}
  {% endif %}
</div>

<!-- Main Content -->
<main class="container-fluid mt-4 px-0">
  {% block content %}{% endblock %}
</main>

<!-- Footer -->
<footer class="text-center">
  <div class="container">
    <p class="mb-0">&copy; {{ now|date:"Y" }} SMARTPACE. All rights reserved.</p>
  </div>
</footer>

<!-- Notification & Toast JS -->
<audio id="notification-sound" src="{% static 'sounds/notification.mp3' %}" preload="auto"></audio>
<div class="toast-container position-fixed top-0 end-0 p-3" id="toast-container" style="z-index: 9999;"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Notifications Script -->
<script>
const shownNotifs = new Set();
const audio = document.getElementById("notification-sound");
let audioUnlocked = false;

document.addEventListener('click', () => {
  if (!audioUnlocked && audio) {
    audio.play().then(()=>{audio.pause();audio.currentTime=0; audioUnlocked=true;}).catch(()=>{});
  }
});

function showToast(message, url='#', tone='primary', photoUrl=''){
  const container = document.getElementById('toast-container');
  if(container.children.length>=3) container.removeChild(container.firstChild);
  const toast = document.createElement('div');
  toast.className = `toast text-bg-${tone} align-items-center border-0 show mb-2`;
  toast.innerHTML = `
    <div class="d-flex">
      ${photoUrl?`<img src="${photoUrl}" class="rounded-circle me-2" style="width:30px;height:30px;" alt="Photo">`:''}
      <div class="toast-body"><a href="${url}" class="text-white text-decoration-none">${message}</a></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>`;
  container.appendChild(toast);
  new bootstrap.Toast(toast,{delay:5000}).show();
}

function fetchNotifications(){
  fetch("{% url 'unread_notifications_json' %}")
    .then(res=>res.json()).then(data=>{
      const notifList = document.getElementById('notif-list');
      const notifCount = document.getElementById('notif-count');
      if(notifList) notifList.innerHTML='';
      if(notifCount) notifCount.textContent = data.length;
      if(data.length===0 && notifList)
        notifList.innerHTML='<li class="dropdown-item text-muted">No new notifications</li>';
      data.forEach(n=>{
        const uniqueId = n.message+n.url;
        if(!shownNotifs.has(uniqueId)){
          showToast(n.message,n.url,n.tone||'primary',n.photo||'');
          shownNotifs.add(uniqueId);
        }
        if(notifList){
          const li=document.createElement('li');
          li.className='dropdown-item';
          li.innerHTML=`<a href="${n.url}" class="text-decoration-none">${n.message}</a>`;
          notifList.appendChild(li);
        }
      });
    }).catch(err=>console.error(err));
}
document.addEventListener("DOMContentLoaded",()=>{ fetchNotifications(); setInterval(fetchNotifications,30000); });
</script>

<!-- Dark/Light Theme JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const toggleBtn = document.getElementById('theme-toggle');
  const html      = document.documentElement;

  // Load saved preference
  const saved = localStorage.getItem('theme');
  if (saved === 'dark') {
    html.setAttribute('data-bs-theme', 'dark');
    toggleBtn.textContent = '‚òÄÔ∏è';
  } else {
    html.setAttribute('data-bs-theme', 'light');
    toggleBtn.textContent = 'üåô';
  }

  // Toggle on click
  toggleBtn.addEventListener('click', () => {
    const isDark = html.getAttribute('data-bs-theme') === 'dark';
    html.setAttribute('data-bs-theme', isDark ? 'light' : 'dark');
    localStorage.setItem('theme', isDark ? 'light' : 'dark');
    toggleBtn.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
  });
});
</script>

{% block extra_js %}{% endblock %}
</body>
</html>
