{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">

  <!-- âœ… Post Title and Image -->
  <h1 class="mb-4">{{ post.title }}</h1>
  {% if post.image %}
    <img src="{{ post.image.url }}" class="img-fluid rounded shadow-sm mb-4" alt="{{ post.title }}">
  {% endif %}

  <!-- âœ… Post Full Content -->
  <div class="mb-5">{{ post.content|linebreaks }}</div>

  <!-- âœ… Welcome Banner -->
  <div class="bg-primary text-white text-center p-5 rounded shadow mb-5 position-relative overflow-hidden">
    <h1 class="display-4">{{ settings.site_name|default:"SMARTPACE" }}</h1>
    <p class="lead">{{ settings.tagline|default:"Empowering Minds Through Science" }}</p>
    <button id="modeToggle" class="btn btn-light position-absolute top-0 end-0 m-3">ğŸŒ™</button>
    <div class="animated-shape shape1"></div>
    <div class="animated-shape shape2"></div>
    <div class="animated-shape shape3"></div>
  </div>

  <!-- âœ… Clock and Calendar -->
  <div class="d-flex justify-content-center align-items-start flex-wrap gap-4 mb-5">
    <div class="bg-light shadow rounded p-4 text-center" style="min-width: 250px;">
      <h4 class="fw-semibold mb-3">ğŸ•’ Current Time</h4>
      <div id="clock" class="fs-2 text-success fw-bold"></div>
    </div>

    <div class="accordion" id="calendarAccordion" style="min-width: 300px;">
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingCalendar">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCalendar">
            ğŸ“… View Calendar
          </button>
        </h2>
        <div id="collapseCalendar" class="accordion-collapse collapse">
          <div class="accordion-body p-0">
            <iframe
              title="Kenyan Holidays Calendar"
              src="https://calendar.google.com/calendar/embed?src=en.kenyan%23holiday%40group.v.calendar.google.com&ctz=Africa%2FNairobi"
              width="100%" height="300" frameborder="0" scrolling="no" style="border:0;"></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… Announcement -->
  <div class="text-center mb-5">
    <button class="btn btn-warning btn-lg fw-bold shadow-sm px-4 py-2" disabled>
      ğŸ“¢ {{ settings.announcement|default:"No announcements today." }}
    </button>
  </div>

  <!-- âœ… Daily Fact -->
  {% if daily_fact %}
    <div class="alert alert-info text-center fw-semibold shadow-sm mb-4">
      ğŸ§¬ <strong>Daily Fact:</strong> {{ daily_fact.text }}
    </div>
  {% else %}
    <div class="alert alert-warning text-center mb-4">
      No daily fact available for today.
    </div>
  {% endif %}

  <!-- âœ… Daily Quote -->
  <div class="my-4 text-center">
    <blockquote class="blockquote">
      <p class="mb-2">â€œ{{ settings.daily_quote|default:"Science is the poetry of reality." }}â€</p>
      <footer class="blockquote-footer">Daily Quote</footer>
    </blockquote>
  </div>

  <!-- âœ… Quiz Categories -->
  <div class="my-5">
    <h3 class="text-center mb-4">ğŸ§  Quiz Categories</h3>
    <ul class="nav nav-tabs justify-content-center mb-3" id="quizTab" role="tablist">
      {% for category in quiz_categories %}
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if forloop.first %}active{% endif %}" id="tab{{ category.id }}-tab"
                  data-bs-toggle="tab" data-bs-target="#tab{{ category.id }}" type="button" role="tab">
            {{ category.name }}
          </button>
        </li>
      {% endfor %}
    </ul>
    <div class="tab-content">
      {% for category in quiz_categories %}
        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="tab{{ category.id }}" role="tabpanel">
          <div class="text-center p-3 border rounded bg-light">
            <h5>{{ category.name }}</h5>
            <a href="{% url 'start_quiz' category.id %}" class="btn btn-success mt-2">
              Start Quiz {% if category.quiz_set.count %} ({{ category.quiz_set.count }}){% endif %}
            </a>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- âœ… Related Blog Posts (Paginated) -->
  {% for post in posts %}
    <div class="card mb-5 shadow">
      {% if post.image %}
        <img src="{{ post.image.url }}" class="card-img-top" alt="{{ post.title }}">
      {% endif %}

      <div class="card-body">
        <h4 class="card-title">{{ post.title }}</h4>
        <p class="text-muted small">By {{ post.author.username }} | {{ post.created|date:"F j, Y" }}</p>

            
{% if post.video %}
 <video width="100%" controls class="mb-3 rounded">
   <source src="{{ post.video.url }}" type="video/mp4">
   Your browser does not support the video tag.
 </video>

  <!-- YouTube embedded video -->
{% elif post.youtube_url and "youtube.com" in post.youtube_url or "youtu.be" in post.youtube_url %}
<div class="mb-3" style="width: 120%; margin: auto;"></div>
 <div class="ratio ratio-16x9 mb-3">
   <iframe
     src="https://www.youtube.com/embed/{{ post.youtube_url|cut:'https://youtu.be/'|cut:'https://www.youtube.com/watch?v=' }}"
     title="YouTube video player"
     allowfullscreen class="border-0 w-250">
   </iframe>
 </div>
{% endif %}

        <!-- âœ… Collapsible Content -->
        <button id="toggleContentBtn-{{ post.pk }}" class="btn btn-primary btn-sm w-100 mb-2" 
                data-bs-toggle="collapse" data-bs-target="#postContent-{{ post.pk }}" 
                aria-expanded="false">
          View Content â¬‡ï¸
        </button>

        <div class="collapse" id="postContent-{{ post.pk }}">
          {{ post.content|linebreaks }}
        </div>

        <!-- âœ… Post Actions -->
        <form method="post" action="{% url 'like_post' post.pk %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm {% if user in post.likes.all %}btn-danger{% else %}btn-outline-danger{% endif %}">
            â¤ï¸ {{ post.likes.count }}
          </button>
        </form>

        <button class="btn btn-sm btn-outline-primary ms-2" data-bs-toggle="collapse" data-bs-target="#comments-{{ post.pk }}">
          ğŸ’¬ Comments ({{ post.comments.count }})
        </button>

        {% if user == post.author %}
          <div class="mt-2">
            <a href="{% url 'edit_post' post.pk %}" class="text-warning small me-2">âœï¸ Edit</a>
            <a href="{% url 'delete_post' post.pk %}" class="text-danger small"
               onclick="return confirm('Are you sure you want to delete this post?')">ğŸ—‘ï¸ Del</a>
          </div>
        {% endif %}
      </div>

      <!-- âœ… Comments Section -->
      <div id="comments-{{ post.pk }}" class="collapse card-body border-top">
        {% if user.is_authenticated %}
          <form method="post" action="{% url 'add_comment' post.pk %}">
            {% csrf_token %}
            {{ comment_form.as_p }}
            <button type="submit" class="btn btn-sm btn-success">Post Comment</button>
          </form>
        {% else %}
          <p><a href="{% url 'login' %}">Login</a> to comment.</p>
        {% endif %}

        {% for comment in post.comments.all %}
          {% if comment.parent is None %}
            <div class="mt-3 border p-2 rounded bg-light">
              <div class="d-flex align-items-center mb-2">
                <img src="{{ comment.user.profile.photo.url }}" class="rounded-circle me-2" style="width: 40px; height: 40px;">
                <div>
                  <strong>{{ comment.user.username }}</strong><br>
                  <small class="text-muted">{{ comment.created_at|date:"M d, Y H:i" }}</small>
                </div>
              </div>
              <p>{{ comment.body }}</p>

              <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#reply-{{ comment.pk }}">Reply</button>
              <div class="collapse mt-2" id="reply-{{ comment.pk }}">
                <form method="post" action="{% url 'add_reply' post.pk comment.pk %}">
                  {% csrf_token %}
                  {{ comment_form.as_p }}
                  <button type="submit" class="btn btn-sm btn-primary">Submit Reply</button>
                </form>
              </div>

              {% for reply in comment.replies.all %}
                <div class="mt-2 ms-4 border p-2 rounded bg-white">
                  <div class="d-flex align-items-center mb-2">
                    <img src="{{ reply.user.profile.photo.url }}" class="rounded-circle me-2" style="width: 35px; height: 35px;">
                    <div>
                      <strong>{{ reply.user.username }}</strong><br>
                      <small class="text-muted">{{ reply.created_at|date:"M d, Y H:i" }}</small>
                    </div>
                  </div>
                  <p>{{ reply.body }}</p>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endfor %}

  <!-- âœ… Pagination -->
  <div class="d-flex justify-content-center">
    <nav>
      <ul class="pagination">
        {% if posts.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ posts.previous_page_number }}">Previous</a>
          </li>
        {% endif %}
        {% for num in posts.paginator.page_range %}
          <li class="page-item {% if posts.number == num %}active{% endif %}">
            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
          </li>
        {% endfor %}
        {% if posts.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ posts.next_page_number }}">Next</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  </div>

</div>

<!-- âœ… Collapse Toggle Script (universal) -->
<script>
  document.querySelectorAll('[id^="toggleContentBtn-"]').forEach(btn => {
    const targetId = btn.dataset.bsTarget;
    const target = document.querySelector(targetId);
    target.addEventListener('show.bs.collapse', () => btn.textContent = 'Hide Content â¬†ï¸');
    target.addEventListener('hide.bs.collapse', () => btn.textContent = 'View Content â¬‡ï¸');
  });
</script>
{% endblock %}
