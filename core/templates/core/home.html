{% extends 'base.html' %}
{% load static youtube_tags humanize widget_tweaks custom_filters custom_tags dict_extras %}
{% load humanize %}
{% block content %}

<!-- <div class="container-fluid px-2 px-sm-4 my-4"> -->
  <!-- üåü Welcome Banner -->
  <section class="text-white text-center p-5 rounded-4 shadow-lg"
    style="background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); font-family: 'Poppins', sans-serif;">
    <h1 class="display-4 fw-bold">{{ settings.site_name|default:"SMARTPACE" }}</h1>
    <p class="lead">{{ settings.tagline|default:"Empowering Minds Through Science" }}</p>
    <div class="text-end mb-3">
      <button id="theme-toggle" class="btn btn-sm btn-outline-secondary" aria-label="Toggle dark mode">üåô</button>
    </div>
  </section>

<!-- Social Bar + Live Clock -->
<section class="py-3 social-bar">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-3 text-center text-md-start px-3">
    <!-- Live Clock -->
    <span class="fs-6" id="live-clock" aria-label="Current Time"></span>

    <!-- Social Media Icons -->
    <div class="d-flex flex-wrap justify-content-center gap-3">
            <a href="https://www.youtube.com/@officialsmartg2543" target="_blank" rel="noopener noreferrer">
          <i class="fab fa-youtube" style="font-size:24px; padding:5px; color:#d11431;"></i>
        </a>


            <a href="https://www.instagram.com/smartpace_g_2025">
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                <i class="fab fa-instagram" style="font-size: 24px;padding: 5px; color: #E1306C;"></i>
            </a>
            <a href="https://www.twitter.com/SmartPoetry">
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                <i class="fab fa-x" style="font-size: 24px;padding: 5px; color: #060557;"></i>
            </a>
            
            <a href="https://www.tiktok.com/@gen_z_001">
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                <i class="fab fa-tiktok" style="font-size: 24px;padding: 5px; color: #060557;"></i>
            </a>
            
           <a href="https://wa.me/254701822481" target="_blank" rel="noopener noreferrer">
              <i class="fab fa-whatsapp" style="font-size: 25px; padding: 5px; color: #05ff0e;"></i>
          </a>

    </div>
  </div>
</section>

<!-- Clock Script -->
<script>
  function updateClock() {
    const clock = document.getElementById('live-clock');
    if (!clock) return;
    clock.textContent = new Date().toLocaleTimeString();
  }
  setInterval(updateClock, 1000);
  updateClock();
</script>

  <!-- Daily Quiz -->
  <div class="card my-4 shadow-sm">
    <div class="card-header bg-primary text-white">üìÖ Daily Quiz</div>
    <div class="card-body">
      {% if daily_quiz %}
        <h5>{{ daily_quiz.title }}</h5>
        <p>{{ daily_quiz.description|truncatewords:25 }}</p>
        <a href="{% url 'quiz_detail' daily_quiz.id %}" class="btn btn-success">Start Today‚Äôs Quiz</a>
      {% else %}
        <p class="text-muted">No quiz set for today.</p>
      {% endif %}
    </div>
  </div>

  <!-- Daily Quote -->
  {% if daily_quote %}
    <div class="daily-quote border rounded p-3 my-3 bg-light shadow-sm mx-auto" style="max-width:600px;">
      <div class="fs-5 fst-italic text-center text-md-start">{{ daily_quote.quote|striptags }}</div>
      <div class="mt-2 text-center text-md-start text-muted">
        {% if daily_quote.author %}
          {{ daily_quote.author }} ‚Äî {{ daily_quote.created|date:"F j, Y" }}
        {% else %}
          {{ daily_quote.created|date:"F j, Y" }}
        {% endif %}
      </div>
    </div>
  {% else %}
    <p>No daily quote available.</p>
  {% endif %}

  <!-- Calendar -->
  <div class="col-12 col-md-6 mx-auto">
    <div class="accordion shadow" id="calendarAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="calendarHeader">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#calendarBody">
            üìÖ View Calendar
          </button>
        </h2>
        <div id="calendarBody" class="accordion-collapse collapse">
          <div class="accordion-body p-0">
            <iframe title="Kenyan Holidays Calendar"
                    src="{{ settings.calendar_url|default:'https://calendar.google.com/calendar/embed?src=en.kenyan%23holiday%40group.v.calendar.google.com&ctz=Africa%2FNairobi' }}"
                    width="100%" height="300" frameborder="0" scrolling="no" style="border:0;">
            </iframe>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Announcement -->
  <div class="text-center mb-5">
    <div class="alert alert-warning fs-5 fw-semibold shadow-sm d-inline-block px-4 py-2" role="alert">
      üì¢ {{ settings.announcement|default:"No announcements today." }}
    </div>
  </div>

  <!-- Quiz Categories -->
  {% if quiz_categories %}
    <section class="my-5">
      <h3 class="text-center mb-4">üß† Quiz Categories</h3>
      <ul class="nav nav-tabs justify-content-center mb-3">
        {% for category in quiz_categories %}
          <li class="nav-item">
            <button class="nav-link {% if forloop.first %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#tab{{ category.id }}">
              {{ category.name }}
            </button>
          </li>
        {% endfor %}
      </ul>
      <div class="tab-content">
        {% for category in quiz_categories %}
          <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="tab{{ category.id }}">
            <div class="text-center bg-light rounded shadow p-4">
              <h5>{{ category.name }}</h5>
              <a href="{% url 'start_quiz' category.id %}" class="btn btn-success mt-2">
                Start Quiz ({{ category.quiz_set.count }})
              </a>
            </div>
          </div>
        {% endfor %}
      </div>
    </section>
  {% endif %}

<!-- Single Post -->
<section class="posts-edge-to-edge">
    {% for post in posts %}
            <div class="post-content">

            <!-- 1Ô∏è‚É£ User Photo & Username -->
            <div class="d-flex align-items-center mb-2">
                <a href="{% url 'user_profile' post.author.username %}" class="d-flex align-items-center text-reset text-decoration-none">
                    <img src="{% if post.author.profile.photo %}{{ post.author.profile.photo.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}"
                    class="rounded-circle me-2 profile-photo" width="40" height="40" alt="{{ post.author.username }}">

                    <strong>{{ post.author.username }}</strong>
                </a>
            </div>
           

            <!-- 2Ô∏è‚É£ Post Title -->
            <h4 class="fw-bold mb-2">{{ post.title }}</h4>

            <!-- 3Ô∏è‚É£ Post Meta -->
            <p class="mb-2 text-muted small">
                ‚Ä¢ {{ post.created|date:"M j, Y" }}
                {% if post.updated > post.created %}
                    ‚Ä¢ Updated {{ post.updated|naturaltime }}
                {% endif %}
                ‚Ä¢ {{ post.category.name }}
            </p>

            <!-- 4Ô∏è‚É£ Media (Image/Video/YouTube) -->
            {% if post.image or post.get_first_image_url %}
              <img src="{% if post.image %}{{ post.image.url }}{% else %}{{ post.get_first_image_url }}{% endif %}"
                   alt="{{ post.title|escape }}" class="w-100 d-block mb-3">
            {% endif %}
            {% if post.video %}
              <video class="w-100 d-block mb-3" controls>
                <source src="{{ post.video.url }}" type="video/mp4">
              </video>
            {% endif %}
            {% if post.youtube_url|is_youtube_link %}
              <div class="ratio ratio-16x9 mb-3">
                <iframe src="{{ post.youtube_url|youtube_embed }}"
                        class="w-100 h-100 border-0"
                        allowfullscreen></iframe>
              </div>
            {% endif %}


 
<p class="mb-3">{{ post.excerpt|default:post.content|safe }}</p>
            {% if user == post.author %}
                <div class="mb-2">
                    <a href="{% url 'edit_post' post.pk %}" class="text-warning me-3">‚úèÔ∏è Edit</a>
                    <a href="{% url 'delete_post' post.pk %}" class="text-danger"
                       onclick="return confirm('Delete this post?')">üóëÔ∏è Delete</a>
                </div>
            {% endif %}

            <!-- Likes -->
            <a href="#"
               class="like-btn text-decoration-none"
               data-post-id="{{ post.id }}">
                <span class="like-icon">
                    {% if user in post.likes.all %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
                </span>
                <span class="like-count ms-1">{{ post.likes.count }}</span>
            </a>

            <!-- Reactions -->
            <div class="reactions d-inline ms-2" data-post-id="{{ post.id }}">
                {% if post.reactions and post.reactions.model.REACTION_CHOICES %}
                    {% for key, emoji in post.reactions.model.REACTION_CHOICES %}
                        <button type="button" class="btn btn-sm btn-light reaction-btn" data-reaction="{{ key }}">
                            {{ emoji }}
                            <span class="count">
                                {% if reaction_counts|dict_get:post.id %}
                                    {{ reaction_counts|dict_get:post.id|dict_get:key|default:0 }}
                                {% else %}
                                    0
                                {% endif %}
                            </span>
                        </button>
                    {% endfor %}
                {% else %}
                    <p class="text-muted d-inline">No reactions yet.</p>
                {% endif %}
            </div>

            <a href="{% url 'post_likes_list' post.pk %}" class="btn btn-link btn-sm ms-2">See who liked</a>

      <!-- Comment Form -->
<h5 class="card-title mt-3">üí¨ Add a Comment</h5>
<form class="comment-form" data-post-id="{{ post.id }}" method="POST" action="{% url 'add_comment' post_id=post.pk %}">
    {% csrf_token %}
    <div class="mb-3">
        {{ comment_form.body|add_class:"form-control" }}
    </div>
    <input type="hidden" name="parent_id" value="">
    <button type="submit" class="btn btn-sm btn-primary">Post Comment</button>
</form>

<!-- Comments Section -->
{% with top_level_comments=comments_map|dict_get:post.pk %}
    <a class="btn btn-sm btn-outline-primary mb-2"
       data-bs-toggle="collapse"
       href="#comments-{{ post.pk }}"
       role="button"
       aria-expanded="false"
       aria-controls="comments-{{ post.pk }}">
        Show Comments
    </a>

    <div class="collapse" id="comments-{{ post.pk }}">
        {% if top_level_comments %}
            <h5 class="mb-3">{{ top_level_comments.count }} Comment{{ top_level_comments.count|pluralize }}</h5>
            {% include "comment_tree.html" with comments=top_level_comments depth=0 %}
        {% else %}
            <p class="text-muted">No comments yet.</p>
        {% endif %}
        <!-- <img src="{{ comment.user.profile.photo.url|default:'https://via.placeholder.com/30' }}"
     class="rounded-circle me-2" width="30" height="30" alt="User"> -->
    </div>
    

<div class="table-responsive">
    {{ post.content|safe }}
</div>


{% endwith %}

</div>



<!-- JS & Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const postId = this.dataset.postId;
            const likeIcon = this.querySelector('.like-icon');
            const likeCount = this.querySelector('.like-count');

            fetch(`/post/toggle-like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ post_id: postId })
            })
            .then(response => response.json())
            .then(data => {
                likeIcon.textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
                likeCount.textContent = data.likes_count;
            });
        });
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;

    // Load saved theme from localStorage
    if (localStorage.getItem('theme') === 'dark') {
        body.classList.add('dark-mode');
    }

    themeToggle.addEventListener('click', function() {
        body.classList.toggle('dark-mode');

        // Save current theme in localStorage
        if (body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
        } else {
            localStorage.setItem('theme', 'light');
        }
    });
});
</script>



<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('form[id^="comment-form-"]').forEach(form => {
        form.addEventListener('submit', async e => {
            e.preventDefault();
            const postId = form.action.split('/').slice(-2, -1)[0];
            const formData = new FormData(form);
            const body = formData.get('body').trim();
            const parent_id = formData.get('parent_id') || null;

            if (!body) return alert('Comment cannot be empty.');

            const response = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ body, parent_id })
            });

            const data = await response.json();

            if (data.success) {
                const container = document.getElementById(`comments-container-${postId}`);
                container.insertAdjacentHTML('beforeend', data.html);
                form.reset();
                form.querySelector('[name=parent_id]').value = '';
            } else {
                alert(data.error || 'Error posting comment.');
            }
        });
    });
});
</script>

<script>
document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(btn => {
  btn.addEventListener('click', function () {
    const target = document.querySelector(this.dataset.bsTarget || this.getAttribute('href'));
    this.textContent = target.classList.contains('show') ? 'Show Comments' : 'Hide Comments';
  });
});
</script>


<!-- ====== Inline CSS for Dark Mode & Styling ====== -->
<style>

  /* Ensure all media scale on small screens */
video,
img,
iframe {
  max-width: 100%;
  height: auto;
}

  /* ===== Body & Dark Mode ===== */
  body {
    background: #f3f0f0;
    color: #9a8f8f;
    transition: background-color 0.3s ease, color 0.3s ease;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  body.dark-mode {
    background: #121212;
    color: #eee;
  }

  /* ===== Theme Toggle Button ===== */
  #theme-toggle {
    width: 35px;
    height: 36px;
    border-radius: 20px;
    border: 2px solid #666;
    background: #ebe3e3;
    color: #666;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  body.dark-mode #theme-toggle {
    border-color: #ccc;
    color: #ccc;
  }

  /* ===== Section Styling (Gray) ===== */
/* Light-mode grey background for the social bar */
body:not(.dark-mode) section.social-bar {
  background-color: #808080;   /* or any grey you like, e.g. #6c757d */
  border-radius: 20px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}

/* Keep the current dark background when dark mode is on */
body.dark-mode section.social-bar {
  background-color: #d7dde2;   /* deep charcoal/black */
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}



  /* ===== Icon Hover Effects ===== */
  section.bg-dark .fa-brands {
    transition: transform 0.2s ease, filter 0.2s ease, color 0.2s ease;
  }

  section.bg-dark .fa-brands:hover {
    transform: scale(1.2);
    filter: brightness(1.3);
  }

  /* ===== Live Clock Styling ===== */
  #live-clock {
    font-weight: 600;
    font-size: 1rem;
    letter-spacing: 1px;
    color: #dcd4c9;
    border: 1px solid #4d4c4a;
    padding: 0.25rem 0.75rem;
    border-radius: 0.25rem;
    background-color: rgba(5, 5, 5, 0.05);
    transition: all 0.3s ease;
  }

  body.dark-mode #live-clock {
    color: #060101;
    border-color: #888;
    background-color: rgba(255, 255, 255, 0.05);
  }

  /* ===== Buttons & Cards Global Improvements ===== */
  .btn, .card {
    transition: all 0.3s ease;
  }

  /* Phones: shrink heading and padding */
@media (max-width: 576px) {}
  section.text-center.p-5 {
    padding: 2rem 1rem;
  }
  section.text-center h1.display-4 {
    font-size: 1.8rem;
  }
  #live-clock {
    font-size: 0.9rem;
    padding: 0.2rem 0.5rem;
  }
  .daily-quote {
    padding: 1rem;
    font-size: 0.95rem;
  }
  .alert.fs-5 {
    font-size: 1rem;
    padding: 0.75rem 1rem;
  }
html, body {
  margin: 0;
  padding: 0;
  
}

/* remove padding from the post wrapper */
.posts-edge-to-edge {
  margin: 0;
  padding: 0;
}

/* make each post truly full width */
.posts-edge-to-edge .post-content {
  width: 100%;               /* use 100% (not 100vw) to avoid scrollbar offset */
  margin: 0;
  padding: 0;
}

/* scale media to fill the container completely */
.post-content img:not(.profile-photo),
.post-content video,
.post-content iframe,
.post-content .ratio-16x9 {
  display: block;
  width: 100%;
  max-width: 100%;
  margin: 0;
  height: auto;
  object-fit: cover;
}




.post-content img:not(.profile-photo),
.post-content video,
.post-content iframe {
  width: 100%;               
  max-height: 80vh;         
  object-fit: contain;       
}

@media (min-width: 1600px) {
  .posts-edge-to-edge > .post-content {
    max-width: 1400px;
  }
}
.post-content .ratio-16x9 {
    width: 100% !important;
    max-width: 100vw;
    height: auto !important;
    margin: 0;
}

.post-content table {
       
    width: 100%;         
    overflow-x: auto;   
    -webkit-overflow-scrolling: touch; 
    border-collapse: collapse;
}


.post-content table::-webkit-scrollbar {
    height: 6px;
}

.post-content table::-webkit-scrollbar-thumb {
    background-color: rgba(0,0,0,0.2);
    border-radius: 3px;
}

.post-content table th,
.post-content table td {
    padding: 0.5rem;
    white-space: nowrap; 
    text-align: left;
}





.comment img.rounded-circle,
.comment-tree img.rounded-circle,
.comments-section img.rounded-circle {
    width: 30px !important;
    height: 30px !important;
    object-fit: cover;
    border-radius: 50%;
}


.post-content table {
  display: block;             
  overflow-x: auto;           
  width: max-content;         
  max-width: 100%;            
}

</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".reaction-btn").forEach(btn => {
        btn.addEventListener("click", function () {
            const container = this.closest(".reactions");
            const postId = container.dataset.postId;
            const reaction = this.dataset.reaction;

            fetch("{% url 'toggle_reaction' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ post_id: postId, reaction: reaction }),
            })
            .then(res => res.json())
            .then(data => {
                // Update all counts in this post‚Äôs reaction group
                for (const [key, value] of Object.entries(data.counts)) {
                    const span = container.querySelector(
                        `.reaction-btn[data-reaction="${key}"] .count`
                    );
                    if (span) span.textContent = value;
                }
            });
        });
    });
});
</script>

{% endfor %}
{% endblock %}
