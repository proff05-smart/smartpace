{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-5">

  <!-- Post Title -->
  <h2 class="mb-3">{{ post.title }}</h2>

  <!-- Post Metadata -->
  <p class="text-muted">
    By <strong>{{ post.author }}</strong> | {{ post.created_at|date:"F j, Y" }} |
    {{ post.category.name }}
  </p>

  <!-- Post Image -->
  {% if post.image %}
    <img src="{{ post.image.url }}" alt="{{ post.title }}" class="img-fluid mb-3 rounded">
  {% endif %}

  <!-- Post Content -->
  <div class="mb-4">
    {{ post.content|linebreaks }}
  </div>

  <!-- Edit/Delete Buttons (Author only) -->
  {% if user == post.author %}
    <div class="mb-4 d-flex gap-2">
      <a href="{% url 'edit_post' post.pk %}" class="btn btn-warning">✏️ Edit</a>
      <a href="{% url 'delete_post' post.pk %}" class="btn btn-danger"
         onclick="return confirm('Are you sure you want to delete this post?')">🗑️ Delete</a>
    </div>
  {% endif %}

  <!-- Like Button -->
  <form method="POST" action="{% url 'like_post' post.pk %}">
    {% csrf_token %}
    <button type="submit" class="btn {% if user in post.likes.all %}btn-success{% else %}btn-outline-success{% endif %}">
      👍 Like ({{ post.total_likes }})
    </button>
  </form>

  <!-- Print / Download -->
  <div class="my-4 d-flex gap-2">
    <button onclick="window.print()" class="btn btn-outline-secondary">🖨️ Print</button>
    <a href="{% url 'download_post_pdf' post.id %}" class="btn btn-outline-primary">📥 Download PDF</a>
  </div>

  <hr>

  <!-- 💬 Leave a Comment -->
  <div class="mb-4">
    <h5>💬 Leave a Comment</h5>
    <form method="POST" action="{% url 'add_comment' post.id %}">
      {% csrf_token %}
      {{ comment_form.body|add_class:"form-control" }}
      <button type="submit" class="btn btn-primary mt-2">Submit Comment</button>
    </form>
  </div>

  <!-- 💬 Comments Section -->
  <h4>💬 Post Comments ({{ top_level_comment_count }})</h4>

  {% for comment in top_level_comments %}
    <div class="mb-3 p-3 border rounded bg-light">
      <div class="d-flex align-items-start">
        <img src="{% if comment.user.profile.profile_pic %}{{ comment.user.profile.profile_pic.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}"
             class="rounded-circle me-3" width="50" height="50" alt="Avatar">

        <div class="w-100">
          <p class="mb-1">
            <strong>{{ comment.user.username }}</strong> — {{ comment.created|naturaltime }}
            <span class="badge bg-secondary float-end">{{ comment.replies.count }} Replies</span>
          </p>
          <p>{{ comment.body }}</p>

          <!-- Like Comment -->
          <form method="POST" action="{% url 'like_comment' comment.id %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm {% if user in comment.likes.all %}btn-success{% else %}btn-outline-success{% endif %}">
              👍 {{ comment.total_likes }}
            </button>
          </form>

          <!-- Edit/Delete (Author only) -->
          {% if user == comment.user %}
            <a href="{% url 'edit_comment' comment.id %}" class="btn btn-sm btn-warning">Edit</a>
            <a href="{% url 'delete_comment' comment.id %}" class="btn btn-sm btn-danger"
               onclick="return confirm('Are you sure you want to delete this comment?')">Delete</a>
          {% endif %}

          <!-- Reply Toggle -->
          <a class="btn btn-sm btn-link" data-bs-toggle="collapse" href="#replyForm{{ comment.id }}">Reply</a>

          <!-- Reply Form -->
          <div id="replyForm{{ comment.id }}" class="collapse mt-2">
            <form method="POST" action="{% url 'reply_comment' post.id comment.id %}">
              {% csrf_token %}
              <textarea name="body" class="form-control" rows="2" placeholder="Write your reply..." required></textarea>
              <button type="submit" class="btn btn-sm btn-primary mt-2">Submit Reply</button>
            </form>
          </div>

          <!-- Replies -->
          {% for reply in comment.replies.all %}
            <div class="ms-4 mt-3 d-flex align-items-start">
              <img src="{% if reply.user.profile.profile_pic %}{{ reply.user.profile.profile_pic.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}"
                   class="rounded-circle me-2" width="40" height="40" alt="Avatar">

              <div class="bg-white p-2 rounded border w-100">
                <p class="mb-1">
                  <strong>{{ reply.user.username }}</strong> — {{ reply.created|naturaltime }}
                </p>
                <p class="mb-0">{{ reply.body }}</p>

                {% if user == reply.user %}
                  <a href="{% url 'edit_comment' reply.id %}" class="btn btn-sm btn-warning">Edit</a>
                  <a href="{% url 'delete_comment' reply.id %}" class="btn btn-sm btn-danger"
                     onclick="return confirm('Are you sure you want to delete this reply?')">Delete</a>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% empty %}
    <p>No comments yet. Be the first to comment!</p>
  {% endfor %}

  <!-- Pagination -->
  <div class="mt-4">
    <nav>
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
        {% endif %}
        <li class="page-item active"><span class="page-link">{{ page_obj.number }}</span></li>
        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
        {% endif %}
      </ul>
    </nav>
  </div>

  <!-- 📚 Related Posts -->
  {% if related_posts %}
    <h5 class="mt-5">📚 Related Posts</h5>
    <div class="row">
      {% for related in related_posts %}
        <div class="col-md-4">
          <div class="card mb-3">
            {% if related.image %}
              <img src="{{ related.image.url }}" class="card-img-top" alt="{{ related.title }}">
            {% endif %}
            <div class="card-body">
              <h6 class="card-title">{{ related.title }}</h6>
              <a href="{% url 'post_detail' related.pk %}" class="btn btn-sm btn-outline-primary">Read More</a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

</div>
{% endblock %}
