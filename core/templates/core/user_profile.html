{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- Profile Section -->
<div class="profile-section d-flex flex-column flex-md-row align-items-center align-items-md-start gap-3 p-3 rounded shadow-sm mb-3" style="max-width:980px; margin:-60px auto 16px;">
  
  <!-- Profile Photo -->
  <div class="text-center text-md-start flex-shrink-0">
    {% if profile_user.profile.photo %}
      <img src="{{ profile_user.profile.photo.url }}" alt="{{ profile_user.username }}" 
           class="profile-photo img-fluid rounded-circle border border-4 shadow-sm" 
           style="width:120px; height:120px; object-fit:cover; cursor:pointer;" 
           data-bs-toggle="modal" data-bs-target="#photoModal">
    {% else %}
      <img src="{% static 'images/default-avatar.png' %}" alt="Default Avatar" 
           class="profile-photo img-fluid rounded-circle border border-4 shadow-sm" 
           style="width:120px; height:120px; object-fit:cover; cursor:pointer;" 
           data-bs-toggle="modal" data-bs-target="#photoModal">
    {% endif %}
  </div>

  <!-- Profile Details -->
  <div class="profile-details flex-grow-1">
    <h1 class="mb-1 fs-4 text-dark dark-text-light">{{ profile_user.username }}</h1>
    
    {% if profile_user.profile.role %}
      <div class="profile-role mb-2 small text-secondary dark-text-muted">{{ profile_user.profile.role }}</div>
    {% endif %}

    <!-- Bio -->
    <div class="profile-bio-container mb-2 small text-dark dark-text-light">
      {% if profile_user.profile.bio %}
        <p id="bio-preview" class="text-break">
          {{ profile_user.profile.bio|truncatechars:200 }}{% if profile_user.profile.bio|length > 200 %}...{% endif %}
        </p>
        {% if profile_user.profile.bio|length > 200 %}
          <a href="javascript:void(0);" id="toggle-bio" class="text-primary fw-semibold small">Read More</a>
        {% endif %}
      {% else %}
        <p class="text-muted small">No bio available.</p>
      {% endif %}
    </div>

    <!-- Buttons -->
    <div class="profile-buttons mt-2 d-flex flex-column flex-sm-row gap-2">
      {% if user == profile_user %}
        <a href="{% url 'profile_edit' %}" class="btn btn-outline-primary btn-sm">Edit Profile</a>
      {% endif %}
      <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-sm">‚Üê Back to Home</a>
    </div>
  </div>
</div>

<!-- JS for Bio Toggle -->
<script>
  const toggleBtn = document.getElementById('toggle-bio');
  const bioPreview = document.getElementById('bio-preview');
  {% if profile_user.profile.bio %}
    const fullBio = `{{ profile_user.profile.bio|escapejs }}`;
  {% endif %}

  if(toggleBtn){
    toggleBtn.addEventListener('click', () => {
      if(toggleBtn.innerText === "Read More"){
        bioPreview.innerText = fullBio;
        toggleBtn.innerText = "Show Less";
      } else {
        bioPreview.innerText = fullBio.substring(0,200) + "...";
        toggleBtn.innerText = "Read More";
      }
    });
  }
</script>

<!-- Profile Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 bg-transparent">
      <div class="modal-body p-0">
        {% if profile_user.profile.photo %}
          <img src="{{ profile_user.profile.photo.url }}" class="img-fluid rounded" alt="{{ profile_user.username }}">
        {% else %}
          <img src="{% static 'images/default-avatar.png' %}" class="img-fluid rounded" alt="{{ profile_user.username }}">
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Content Section -->
<div class="content-section d-flex flex-column flex-lg-row gap-3 px-3" style="max-width:980px; margin:0 auto 16px;">

  <!-- Left Column -->
  <div class="left-column flex-shrink-0 flex-grow-0 flex-lg-grow-1 bg-white dark-bg-secondary rounded shadow-sm p-3 mb-3 mb-lg-0">
    <h5 class="text-dark dark-text-light">Know me</h5>
    <div class="table-responsive">
      <table class="table table-borderless mb-0 text-dark dark-text-light">
        <tbody>
          <tr>
            <th class="text-secondary dark-text-muted" style="width:35%;">Full Name</th>
            <td>{{ profile_user.first_name }} {{ profile_user.last_name }}</td>
          </tr>
          <tr>
            <th class="text-secondary dark-text-muted">Email</th>
            <td>{{ profile_user.email }}</td>
          </tr>
          <tr>
            <th class="text-secondary dark-text-muted">Joined</th>
            <td>{{ profile_user.date_joined|date:"F j, Y" }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Right Column -->
  <div class="right-column flex-grow-1">

    <!-- Posts -->
    <h3 class="section-title mb-3 fw-bold section-title-text">Posts</h3>
    {% if user_posts %}
      <div class="table-responsive">
        <table class="table table-hover align-middle post-table">
          <thead class="table-light dark-bg-secondary">
            <tr>
              <th>Title</th>
              <th>Excerpt</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for post in user_posts %}
              <tr>
                <td class="post-title">{{ post.title }}</td>
                <td class="post-excerpt">{{ post.excerpt|truncatewords:30 }}</td>
                <td><a href="{% url 'post_detail' post.pk %}" class="post-link fw-semibold">Open</a></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">No posts yet.</p>
    {% endif %}

    <!-- Quiz History -->
    <h3 class="section-title mt-4 mb-2 text-dark dark-text-light fw-bold">Quiz History</h3>
    {% if quiz_attempts %}
      <div class="table-responsive">
        <table class="table table-hover align-middle text-dark dark-text-light">
          <thead class="table-light dark-bg-secondary">
            <tr>
              <th>Category</th>
              <th>Score</th>
              <th>Total Qs</th>
              <th>Percentage</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for attempt in quiz_attempts %}
              <tr>
                <td>{% if attempt.quiz and attempt.quiz.category %}{{ attempt.quiz.category.name }}{% else %}{{ attempt.category.name }}{% endif %}</td>
                <td>{{ attempt.score }}</td>
                <td>{{ attempt.total_questions }}</td>
                <td>
                  <div class="progress" style="height:14px; border-radius:7px;">
                    <div class="progress-bar 
                      {% if attempt.percentage >= 80 %}bg-success
                      {% elif attempt.percentage >= 50 %}bg-warning
                      {% else %}bg-danger
                      {% endif %}" 
                      role="progressbar" style="width: {{ attempt.percentage }}%; height:100%;">
                      {{ attempt.percentage }}%
                    </div>
                  </div>
                </td>
                <td>{{ attempt.date_taken|date:"M d, Y H:i" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">No quiz attempts found.</p>
    {% endif %}

  </div>
</div>

<style>
/* Dark mode text colors */
body.dark-mode .dark-text-light { color: #f1f1f1 !important; }
body.dark-mode .dark-text-muted { color: #b0b3b8 !important; }
body.dark-mode .dark-bg-secondary { background-color: #1c1e21 !important; }

/* Section title */
.section-title-text { color: #1c1e21; }
body.dark-mode .section-title-text { color: #f1f1f1 !important; }

/* Post table */
.post-title { color: #0d6efd; }
.post-excerpt { color: #212529; }
.post-link { color: #0d6efd; text-decoration: none; }

body.dark-mode .post-title,
body.dark-mode .post-excerpt,
body.dark-mode .post-link { color: #f1f1f1 !important; }
body.dark-mode .post-link { color: #87ceeb !important; }

/* Responsive adjustments */
@media (max-width: 576px) {
  .profile-bio-container, .post-excerpt, .post-title { font-size: 13px; }
  .profile-buttons { flex-direction: column; }
  .left-column, .right-column { width: 100%; }
  .table-responsive { overflow-x: auto; }
}
</style>

{% endblock %}
