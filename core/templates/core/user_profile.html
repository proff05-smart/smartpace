{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
/* ---------- Global ---------- */
body {
  background: #f5f7fa;
  color: #2c3e50;
  font-family: 'Inter', sans-serif;
}

/* ---------- Hero / Profile Header ---------- */
.profile-hero {
  background: linear-gradient(135deg, #6f42c1, #6610f2);
  color: #fff;
  padding: 4rem 2rem;
  text-align: center;
  border-radius: 0 0 2rem 2rem;
}
.profile-hero img {
  width: 150px;
  height: 150px;
  object-fit: cover;
  border-radius: 50%;
  border: 5px solid #fff;
  box-shadow: 0 6px 20px rgba(0,0,0,.25);
}
.profile-hero h1 {
  margin-top: 1rem;
  font-weight: 700;
  font-size: 2rem;
}

/* ---------- Info Card ---------- */
.info-card {
  margin-top: -3rem;
  background: #fff;
  border-radius: 1rem;
  box-shadow: 0 8px 20px rgba(0,0,0,.08);
  padding: 2rem;
}
.info-card table th {
  width: 30%;
  color: #6c757d;
}

/* ---------- Section Headings ---------- */
.section-title {
  font-weight: 600;
  margin: 3rem 0 1rem;
  color: #34495e;
}

/* ---------- Posts Grid ---------- */
.post-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
}
.post-card {
  background: #fff;
  border-radius: 1rem;
  box-shadow: 0 6px 18px rgba(0,0,0,.06);
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  transition: transform .3s;
}
.post-card:hover {
  transform: translateY(-4px);
}
.post-card h5 {
  font-weight: 600;
}

/* ---------- Quiz Table ---------- */
.quiz-table .progress {
  height: 16px;
  border-radius: 8px;
}
.progress-success { background: linear-gradient(90deg,#28a745,#85e085);}
.progress-warning { background: linear-gradient(90deg,#ffc107,#ffe680); color:#000;}
.progress-danger  { background: linear-gradient(90deg,#dc3545,#ff6b6b); }

/* ---------- Buttons ---------- */
.btn-outline-primary {
  border-radius: 50px;
  padding: 0.4rem 1rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.progress-bar').forEach(bar => {
    const width = bar.dataset.width;
    const type = bar.dataset.type;
    setTimeout(() => {
      bar.style.width = width + '%';
      bar.classList.add(type);
      bar.textContent = width + '%';
    }, 300);
  });
});
</script>
{% endblock %}

{% block content %}
<div class="profile-hero">
  {% if profile_user.profile.photo %}
    <img src="{{ profile_user.profile.photo.url }}" alt="{{ profile_user.username }}">
  {% else %}
    <img src="{% static 'images/default-avatar.png' %}" alt="Default Avatar">
  {% endif %}
  <h1>{{ profile_user.username }}</h1>
  {% if profile_user.profile.role %}
    <span class="badge bg-light text-dark mt-2 px-3 py-2">{{ profile_user.profile.role }}</span>
  {% endif %}
</div>

<div class="container">
  <!-- Info Card -->
  <div class="info-card">
    <table class="table mb-0">
      <tbody>
        <tr><th>Full Name</th><td>{{ profile_user.first_name }} {{ profile_user.last_name }}</td></tr>
        <tr><th>Email</th><td>{{ profile_user.email }}</td></tr>
        <tr><th>Date Joined</th><td>{{ profile_user.date_joined|date:"F j, Y" }}</td></tr>
      </tbody>
    </table>

    <hr>
    <h5>Bio</h5>
    {% if profile_user.profile.bio %}
      {% with profile_user.profile.bio|linebreaksbr as bio_html %}
        {% with bio_html|safe as full_bio %}
          {% if full_bio|length > 300 %}
            <p id="short-bio">{{ full_bio|slice:":300" }}...</p>
            <div class="collapse" id="fullBio"><p>{{ full_bio|safe }}</p></div>
            <button class="btn btn-link p-0" data-bs-toggle="collapse" data-bs-target="#fullBio">
              Read more
            </button>
          {% else %}
            <p>{{ full_bio|safe }}</p>
          {% endif %}
        {% endwith %}
      {% endwith %}
    {% else %}
      <p class="text-muted">No bio available.</p>
    {% endif %}

    <div class="mt-3">
      {% if user == profile_user %}
        <a href="{% url 'profile_edit' %}" class="btn btn-outline-primary btn-sm me-2">Edit Profile</a>
      {% endif %}
      <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-sm">‚Üê Back to Home</a>
    </div>
  </div>

  <!-- Blog Posts -->
  <h3 class="section-title">üìù Blog Posts</h3>
  {% if user_posts %}
    <div class="post-grid">
      {% for post in user_posts %}
        <div class="post-card">
          <h5>{{ post.title }}</h5>
          <p class="flex-grow-1">{{ post.excerpt|truncatewords:30 }}</p>
          <a href="{% url 'post_detail' post.pk %}" class="btn btn-primary btn-sm mt-2">Read More</a>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">This user has not published any posts yet.</p>
  {% endif %}

  <!-- Quiz History -->
  <h3 class="section-title">üß† Quiz History</h3>
  {% if quiz_attempts %}
    <div class="table-responsive quiz-table">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Category</th>
            <th>Score</th>
            <th>Total Qs</th>
            <th>Percentage</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% for attempt in quiz_attempts %}
            <tr>
              <td>{% if attempt.quiz and attempt.quiz.category %}{{ attempt.quiz.category.name }}{% else %}{{ attempt.category.name }}{% endif %}</td>
              <td>{{ attempt.score }}</td>
              <td>{{ attempt.total_questions }}</td>
              <td>
                <div class="progress">
                  <div class="progress-bar" role="progressbar" data-width="{{ attempt.percentage }}"
                       data-type="{% if attempt.percentage >= 80 %}progress-success{% elif attempt.percentage >= 50 %}progress-warning{% else %}progress-danger{% endif %}">
                    0%
                  </div>
                </div>
              </td>
              <td>{{ attempt.date_taken|date:"M d, Y H:i" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-muted">No quiz attempts found.</p>
  {% endif %}
</div>
{% endblock %}
