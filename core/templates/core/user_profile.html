{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
/* ================== Theme Variables ================== */
:root {
  --bg-color: #ffffff;
  --text-color: #212529;
  --card-bg: #f8f9fa;
  --table-header-bg: #343a40;
  --table-header-color: #fff;
  --badge-bg: linear-gradient(135deg, #6f42c1, #6610f2);
  --read-more-color: #0d6efd;
}
body.dark-mode {
  --bg-color: #121212;
  --text-color: #f8f9fa;
  --card-bg: #1e1e1e;
  --table-header-bg: #212121;
  --table-header-color: #f8f9fa;
  --badge-bg: linear-gradient(135deg, #6f42c1, #6610f2);
  --read-more-color: #0d6efd;
}

body {
  background-color: var(--bg-color);
  color: var(--text-color);
  transition: background-color 0.4s, color 0.4s;
}

/* ================== Neumorphic Cards ================== */
.neumorphic-card {
  border-radius: 1rem;
  background-color: var(--card-bg);
  color: var(--text-color);
  box-shadow: 8px 8px 16px rgba(0,0,0,0.05), -8px -8px 16px rgba(255,255,255,0.7);
  transition: transform 0.3s, box-shadow 0.3s, opacity 0.5s, background-color 0.4s, color 0.4s;
  opacity: 0;
  transform: translateY(20px);
}
.neumorphic-card.visible {
  opacity: 1;
  transform: translateY(0);
}
.neumorphic-card:hover {
  transform: translateY(-5px);
  box-shadow: 12px 12px 24px rgba(0,0,0,0.1), -12px -12px 24px rgba(255,255,255,0.8);
}

/* ================== Profile Picture ================== */
.profile-pic {
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  transition: box-shadow 0.4s;
}

/* ================== Read More Button ================== */
.read-more-btn {
  font-weight: 500;
  text-decoration: none;
  color: var(--read-more-color);
  transition: color 0.3s;
}
.read-more-btn:hover {
  text-decoration: underline;
}

/* ================== Tables ================== */
.table th, .table td {
  color: var(--text-color);
  transition: color 0.4s;
}
.table thead {
  background-color: var(--table-header-bg);
  color: var(--table-header-color);
  transition: background-color 0.4s, color 0.4s;
}
.table-hover tbody tr:hover {
  background-color: var(--card-bg);
  cursor: pointer;
}

/* ================== Quiz Row ================== */
.quiz-row {
  opacity: 0;
  transform: translateX(-20px);
  transition: all 0.6s ease;
}
.quiz-row.visible {
  opacity: 1;
  transform: translateX(0);
}

/* ================== Progress Bars ================== */
.progress {
  height: 20px;
  border-radius: 10px;
  overflow: hidden;
  background-color: #e9ecef;
}
.progress-bar {
  transition: width 1.5s ease-in-out, background 1.5s ease-in-out;
  text-align: center;
  font-weight: 500;
  color: #fff;
}
.progress-success { background: linear-gradient(90deg, #28a745, #85e085); }
.progress-warning { background: linear-gradient(90deg, #ffc107, #ffe680); color: #000; }
.progress-danger { background: linear-gradient(90deg, #dc3545, #ff6b6b); }

/* ================== Gradient Badges ================== */
.badge-gradient {
  background: var(--badge-bg);
  color: #fff;
  font-weight: 500;
  transition: background 0.4s;
}

/* ================== Collapse Smooth Animation ================== */
.collapse:not(.show) {
  display: block;
  height: 0;
  overflow: hidden;
  transition: height 0.3s ease;
}

/* ================== Dark Mode Toggle Button ================== */
#darkModeToggle {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  z-index: 999;
  background-color: var(--card-bg);
  color: var(--text-color);
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 50px;
  box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
  cursor: pointer;
  transition: all 0.4s;
}
#darkModeToggle:hover {
  box-shadow: 4px 4px 14px rgba(0,0,0,0.3);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Animate cards
  document.querySelectorAll('.neumorphic-card').forEach((card, i) => {
    setTimeout(() => card.classList.add('visible'), i * 100);
  });

  // Animate quiz rows
  document.querySelectorAll('.quiz-row').forEach((row, i) => {
    setTimeout(() => row.classList.add('visible'), i * 150);
  });

  // Animate progress bars
  document.querySelectorAll('.progress-bar').forEach(bar => {
    const width = bar.getAttribute('data-width');
    const type = bar.getAttribute('data-type');
    setTimeout(() => {
      bar.style.width = width + '%';
      bar.classList.add(type);
      bar.setAttribute('aria-valuenow', width);
      bar.innerText = width + '%';
    }, 500);
  });

  // Read more toggle text
  document.querySelectorAll('.read-more-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      btn.innerText = btn.innerText === 'Read more' ? 'Read less' : 'Read more';
    });
  });

  // Dark mode toggle
  const toggleBtn = document.getElementById('darkModeToggle');
  if (toggleBtn) {
    // Load saved theme
    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

    toggleBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });
  }
});
</script>
{% endblock %}

{% block content %}
<div class="container my-5">

  <!-- Dark Mode Toggle Button -->
  <button id="darkModeToggle">üåì Toggle Dark Mode</button>

  <div class="row g-4 align-items-center">
    <!-- Profile Picture -->
    <div class="col-12 col-md-3 text-center">
      {% if profile_user.profile.photo %}
        <img loading="lazy" src="{{ profile_user.profile.photo.url }}" class="rounded-circle profile-pic img-fluid" style="max-width:150px;" alt="{{ profile_user.username }}">
      {% else %}
        <img loading="lazy" src="{% static 'images/default-avatar.png' %}" class="rounded-circle profile-pic img-fluid" style="max-width:150px;" alt="Default Avatar">
      {% endif %}
    </div>

    <!-- Profile Info -->
    <div class="col-12 col-md-9">
      <div class="neumorphic-card p-4 shadow-sm">
        <h2 class="mb-3">{{ profile_user.username }}</h2>

        <div class="table-responsive mb-3">
          <table class="table table-hover table-bordered shadow-sm table-striped">
            <caption>Profile details for {{ profile_user.username }}</caption>
            <tbody>
              <tr>
                <th scope="row">Full Name</th>
                <td>{{ profile_user.first_name }} {{ profile_user.last_name }}</td>
              </tr>
              <tr>
                <th scope="row">Email</th>
                <td>{{ profile_user.email }}</td>
              </tr>
              <tr>
                <th scope="row">Role</th>
                <td>
                  {% if profile_user.profile.role %}
                    <span class="badge badge-gradient px-3 py-2" role="status">{{ profile_user.profile.role }}</span>
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
              </tr>
              <tr>
                <th scope="row">Date Joined</th>
                <td>{{ profile_user.date_joined|date:"F j, Y" }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Bio -->
        <h5 class="mt-3">Bio</h5>
        {% if profile_user.profile.bio %}
          {% with profile_user.profile.bio|linebreaksbr as bio_html %}
            {% with bio_html|safe as full_bio %}
              {% if full_bio|length > 300 %}
                <p id="short-bio">{{ full_bio|slice:":300" }}...</p>
                <div class="collapse" id="fullBio">
                  <p>{{ full_bio|safe }}</p>
                </div>
                <button class="btn btn-link p-0 read-more-btn" type="button" data-bs-toggle="collapse" data-bs-target="#fullBio" aria-expanded="false" aria-controls="fullBio">
                  Read more
                </button>
              {% else %}
                <p>{{ full_bio|safe }}</p>
              {% endif %}
            {% endwith %}
          {% endwith %}
        {% else %}
          <p class="text-muted">No bio available.</p>
        {% endif %}

        <!-- Action Buttons -->
        <div class="mt-3">
          {% if user == profile_user %}
            <a href="{% url 'profile_edit' %}" class="btn btn-outline-primary btn-sm me-2">Edit Profile</a>
          {% endif %}
          <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-sm">‚Üê Back to Home</a>
        </div>
      </div>
    </div>
  </div>

  <hr class="my-5">

  <!-- Blog Posts -->
  <div class="mt-4">
    <h4 class="mb-3">üìù Blog Posts by {{ profile_user.username }}</h4>
    {% if user_posts %}
      <div class="row g-3">
        {% for post in user_posts %}
          <div class="col-12 col-md-6">
            <div class="neumorphic-card h-100 p-3 shadow-sm d-flex flex-column">
              <h5 class="card-title">{{ post.title }}</h5>
              <p class="card-text flex-grow-1">{{ post.excerpt|truncatewords:30 }}</p>
              <a href="{% url 'post_detail' post.pk %}" class="btn btn-primary btn-sm mt-2 align-self-start">Read More</a>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">This user has not published any posts yet.</p>
    {% endif %}
  </div>

  <hr class="my-5">

  <!-- Quiz History -->
  <div class="mt-4">
    <h4 class="mb-3">üß† Quiz History</h4>
    {% if quiz_attempts %}
      <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered shadow-sm">
          <caption>Quiz history for {{ profile_user.username }}</caption>
          <thead>
            <tr>
              <th>Quiz Category</th>
              <th>Score</th>
              <th>Total Questions</th>
              <th>Percentage</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for attempt in quiz_attempts %}
              <tr class="quiz-row">
                <td>{% if attempt.quiz and attempt.quiz.category %}{{ attempt.quiz.category.name }}{% else %}{{ attempt.category.name }}{% endif %}</td>
                <td>{{ attempt.score }}</td>
                <td>{{ attempt.total_questions }}</td>
                <td>
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100"
                         data-width="{{ attempt.percentage }}"
                         data-type="{% if attempt.percentage >= 80 %}progress-success{% elif attempt.percentage >= 50 %}progress-warning{% else %}progress-danger{% endif %}">
                      0%
                    </div>
                  </div>
                </td>
                <td>{{ attempt.date_taken|date:"M d, Y H:i" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">No quiz attempts found for this user.</p>
    {% endif %}
  </div>

</div>
{% endblock %}
